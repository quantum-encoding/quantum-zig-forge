{
  "profile_name": "harvester-safe",
  "description": "Specialized profile for codebase_compiler (Sovereign Harvester) - allows reading source code and writing to single output file",
  "version": "1.0.0",
  "author": "Quantum Garden Forge - The Triumvirate",
  "threat_model": "Trusted Rust binary (codebase_compiler) compiling workspace into artifact - needs read access to all files and write access to output file only",

  "syscalls": {
    "default_action": "errno",
    "comment": "Based on strace analysis - minimal syscalls for parallel file compilation",
    "errno_value": 13,

    "allowed": [
      "read",
      "pread64",
      "readv",
      "preadv",
      "preadv2",
      "write",
      "writev",
      "pwrite64",
      "pwritev",
      "pwritev2",
      "open",
      "openat",
      "close",
      "stat",
      "fstat",
      "lstat",
      "newfstatat",
      "statx",
      "access",
      "faccessat",
      "faccessat2",
      "readlink",
      "readlinkat",
      "getcwd",
      "chdir",
      "fchdir",
      "getdents",
      "getdents64",
      "lseek",
      "dup",
      "dup2",
      "dup3",
      "fcntl",
      "getrlimit",
      "prlimit64",
      "gettimeofday",
      "clock_gettime",
      "nanosleep",
      "getpid",
      "gettid",
      "getppid",
      "getuid",
      "geteuid",
      "getgid",
      "getegid",
      "prctl",
      "arch_prctl",
      "mmap",
      "munmap",
      "mremap",
      "mprotect",
      "madvise",
      "brk",
      "rt_sigaction",
      "rt_sigprocmask",
      "rt_sigreturn",
      "sigaltstack",
      "uname",
      "getrandom",
      "futex",
      "set_tid_address",
      "set_robust_list",
      "exit",
      "exit_group",
      "poll",
      "ppoll",
      "execve",
      "sched_yield",
      "sched_getaffinity",
      "rseq",
      "mkdir",
      "mkdirat",
      "fchmod",
      "copy_file_range"
    ],

    "blocked": [
      "unlink",
      "unlinkat",
      "rmdir",
      "rename",
      "renameat",
      "renameat2",
      "link",
      "linkat",
      "symlink",
      "symlinkat",
      "mknod",
      "mknodat",
      "chmod",
      "fchmodat",
      "chown",
      "fchown",
      "lchown",
      "fchownat",
      "truncate",
      "ftruncate",
      "fsync",
      "fdatasync",
      "sync",
      "syncfs",
      "flock",
      "mount",
      "umount",
      "umount2",
      "pivot_root",
      "chroot",
      "socket",
      "socketpair",
      "bind",
      "listen",
      "accept",
      "accept4",
      "connect",
      "sendto",
      "sendmsg",
      "sendmmsg",
      "shutdown",
      "setsockopt",
      "ptrace",
      "process_vm_writev",
      "bpf",
      "userfaultfd",
      "perf_event_open"
    ],

    "conditional": []
  },

  "capabilities": {
    "comment": "Drop all capabilities - no special privileges needed",
    "drop_all": true,
    "keep": []
  },

  "namespaces": {
    "comment": "No namespace isolation - harvester needs access to workspace filesystem",
    "enabled": [],
    "network": "none"
  },

  "filesystem": {
    "comment": "Workspace path will be bind-mounted - harvester can read entire workspace and write output",
    "protected_paths": [],
    "writable_sandbox": []
  },

  "limits": {
    "max_open_files": 2048,
    "max_memory_mb": 1024,
    "max_cpu_time_sec": 60,
    "max_processes": 32
  },

  "audit": {
    "log_violations": true,
    "log_allowed": false,
    "log_target": "stderr",
    "auditd_integration": true,
    "auditd_key": "zig_jail_harvester_safe"
  },

  "metadata": {
    "created": "2025-10-17",
    "tested_with": ["codebase_compiler v1.0.0"],
    "use_cases": [
      "Perpetual Cultivation Loop - harvesting workspace into Sovereign Artifact",
      "Parallel file compilation with minimal syscall overhead",
      "Trusted Rust binary with read-mostly workload"
    ],
    "known_limitations": [
      "Can create directories and write files (by design - needs to create output)",
      "Cannot delete or rename files (safety - preserves workspace integrity)",
      "No network access (harvester is offline-only)",
      "Cannot modify file permissions except via fchmod (needed for output file)"
    ],
    "syscall_analysis": {
      "comment": "Based on strace reconnaissance of codebase_compiler",
      "critical_syscalls": [
        "write - required for output file",
        "mkdir - required for creating output directory structure",
        "fchmod - required for setting output file permissions",
        "copy_file_range - used for efficient file copying",
        "getdents64 - required for directory traversal"
      ],
      "removed_from_shell_readonly": [
        "Removed: waitpid, ttyname, isatty, tcgetattr (terminal control - not needed)",
        "Removed: clone, clone3, fork, vfork, execveat (process spawning - harvester is single-process)",
        "Removed: ioctl (terminal operations - not needed)"
      ],
      "added_to_shell_readonly": [
        "Added: write (required for output file)",
        "Added: mkdir, mkdirat (required for output directory)",
        "Added: fchmod (required for output file permissions)",
        "Added: copy_file_range (efficient file operations)"
      ]
    },
    "usage_examples": [
      "zig-jail --profile=harvester-safe --bind=/workspace:/workspace -- codebase_compiler --path /workspace --output /workspace/harvest.md",
      "execute_sandboxed(app_handle, SecurityProfile::HarvesterSafe, \"codebase_compiler\", &args, workspace_path)"
    ]
  }
}
