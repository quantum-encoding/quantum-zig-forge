#!/bin/bash

# The King's Scepter - Control Interface for the Great Synapse
# This sacred tool grants dominion over the immortal trading daemon

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVICE_NAME="great-synapse"
BINARY_PATH="$SCRIPT_DIR/go-bridge/unified_system_daemon"
PID_FILE="/var/run/great-synapse.pid"
ALT_PID_FILE="$HOME/.great-synapse/synapse.pid"
LOG_DIR="/var/log/great-synapse"
ALT_LOG_DIR="$HOME/.great-synapse/logs"

# Colors for divine output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ASCII Art Banner
print_banner() {
    echo -e "${PURPLE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          THE GREAT SYNAPSE CONTROL             â•‘"
    echo "â•‘               The King's Scepter               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# Check if running with systemd
check_systemd() {
    if systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
        return 0
    fi
    return 1
}

# Get PID of the daemon
get_pid() {
    if [ -f "$PID_FILE" ]; then
        cat "$PID_FILE"
    elif [ -f "$ALT_PID_FILE" ]; then
        cat "$ALT_PID_FILE"
    else
        pgrep -f "unified_system_daemon"
    fi
}

# Check if daemon is running
is_running() {
    local pid=$(get_pid)
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
        return 0
    fi
    return 1
}

# Start the daemon
start_daemon() {
    echo -e "${CYAN}âš¡ Awakening the Great Synapse...${NC}"
    
    # Check if already running
    if is_running; then
        echo -e "${YELLOW}âš ï¸  The Great Synapse is already awake!${NC}"
        return 0
    fi
    
    # Build if necessary
    if [ ! -f "$BINARY_PATH" ]; then
        echo -e "${YELLOW}Building the daemon...${NC}"
        cd "$SCRIPT_DIR/go-bridge"
        
        # Build Zig library
        echo "Building Zig HFT engine..."
        cd "$SCRIPT_DIR"
        /home/rich/productions/codebase_navigator_expansion/zig-x86_64-linux-0.16.0-dev.23+47a2f2dda/zig build-lib \
            src/c_api.zig -dynamic -O ReleaseFast -femit-bin=go-bridge/libc_api.so
        
        # Build Go daemon
        echo "Building Go daemon..."
        cd "$SCRIPT_DIR/go-bridge"
        CGO_ENABLED=1 go build -o unified_system_daemon unified_system_daemon.go
    fi
    
    # Try systemd first
    if systemctl list-unit-files | grep -q "$SERVICE_NAME"; then
        echo -e "${GREEN}Starting via systemd...${NC}"
        sudo systemctl start "$SERVICE_NAME"
        sleep 2
        if systemctl is-active --quiet "$SERVICE_NAME"; then
            echo -e "${GREEN}âœ… The Great Synapse has awakened via systemd!${NC}"
            return 0
        fi
    fi
    
    # Fallback to manual start
    echo -e "${YELLOW}Starting manually...${NC}"
    
    # Create necessary directories
    mkdir -p "$HOME/.great-synapse/logs"
    mkdir -p "$HOME/.great-synapse/state"
    
    # Export environment variables
    export LD_LIBRARY_PATH="$SCRIPT_DIR/go-bridge:$LD_LIBRARY_PATH"
    export ALPACA_API_KEY="PKHCX1EU4AQ2YTLBNRV9"
    export ALPACA_API_SECRET="GxJtN5QhxaGg3cQ2URV9zTG7qiV3RlJnyigK3ZgQ"
    
    # Start the daemon
    cd "$SCRIPT_DIR/go-bridge"
    nohup ./unified_system_daemon > "$HOME/.great-synapse/logs/startup.log" 2>&1 &
    local pid=$!
    
    # Wait for startup
    sleep 3
    
    if kill -0 "$pid" 2>/dev/null; then
        echo -e "${GREEN}âœ… The Great Synapse has awakened! (PID: $pid)${NC}"
        echo "$pid" > "$ALT_PID_FILE"
        return 0
    else
        echo -e "${RED}âŒ Failed to awaken the Great Synapse${NC}"
        echo "Check logs at: $HOME/.great-synapse/logs/"
        return 1
    fi
}

# Stop the daemon
stop_daemon() {
    echo -e "${CYAN}ðŸ›‘ Commanding the Great Synapse to rest...${NC}"
    
    # Try systemd first
    if check_systemd; then
        echo -e "${YELLOW}Stopping via systemd...${NC}"
        sudo systemctl stop "$SERVICE_NAME"
        echo -e "${GREEN}âœ… The Great Synapse rests${NC}"
        return 0
    fi
    
    # Manual stop
    local pid=$(get_pid)
    if [ -z "$pid" ]; then
        echo -e "${YELLOW}âš ï¸  The Great Synapse is already at rest${NC}"
        return 0
    fi
    
    echo -e "${YELLOW}Sending shutdown signal to PID $pid...${NC}"
    kill -TERM "$pid" 2>/dev/null
    
    # Wait for graceful shutdown
    local count=0
    while [ $count -lt 10 ] && kill -0 "$pid" 2>/dev/null; do
        sleep 1
        count=$((count + 1))
    done
    
    if kill -0 "$pid" 2>/dev/null; then
        echo -e "${YELLOW}Force stopping...${NC}"
        kill -9 "$pid" 2>/dev/null
    fi
    
    rm -f "$PID_FILE" "$ALT_PID_FILE"
    echo -e "${GREEN}âœ… The Great Synapse rests${NC}"
}

# Restart the daemon
restart_daemon() {
    echo -e "${CYAN}ðŸ”„ Reincarnating the Great Synapse...${NC}"
    stop_daemon
    sleep 2
    start_daemon
}

# Show status
show_status() {
    echo -e "${CYAN}ðŸ“Š === GREAT SYNAPSE STATUS ===${NC}"
    
    # Check systemd status
    if systemctl list-unit-files | grep -q "$SERVICE_NAME"; then
        if check_systemd; then
            echo -e "${GREEN}âš¡ Status: ACTIVE (systemd)${NC}"
            systemctl status "$SERVICE_NAME" --no-pager | head -n 10
        else
            echo -e "${YELLOW}ðŸ’¤ Status: INACTIVE (systemd)${NC}"
        fi
    fi
    
    # Check manual process
    local pid=$(get_pid)
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
        echo -e "${GREEN}âš¡ Status: RUNNING (PID: $pid)${NC}"
        
        # Show process info
        echo -e "\n${CYAN}Process Information:${NC}"
        ps -p "$pid" -o pid,vsz,rss,pcpu,pmem,etime,comm
        
        # Show recent logs
        echo -e "\n${CYAN}Recent Activity:${NC}"
        if [ -d "$LOG_DIR" ]; then
            tail -n 5 "$LOG_DIR"/synapse_*.log 2>/dev/null
        elif [ -d "$ALT_LOG_DIR" ]; then
            tail -n 5 "$ALT_LOG_DIR"/synapse_*.log 2>/dev/null
        fi
    else
        echo -e "${RED}ðŸ’€ Status: NOT RUNNING${NC}"
    fi
    
    # Show metrics if available
    if [ -f "$HOME/.great-synapse/state/metrics.json" ]; then
        echo -e "\n${CYAN}Performance Metrics:${NC}"
        cat "$HOME/.great-synapse/state/metrics.json" 2>/dev/null | head -n 10
    fi
}

# Show logs
show_logs() {
    echo -e "${CYAN}ðŸ“œ === GREAT SYNAPSE LOGS ===${NC}"
    
    local log_file=""
    if [ -d "$LOG_DIR" ]; then
        log_file=$(ls -t "$LOG_DIR"/synapse_*.log 2>/dev/null | head -n 1)
    elif [ -d "$ALT_LOG_DIR" ]; then
        log_file=$(ls -t "$ALT_LOG_DIR"/synapse_*.log 2>/dev/null | head -n 1)
    fi
    
    if [ -n "$log_file" ]; then
        echo "Following: $log_file"
        tail -f "$log_file"
    else
        echo -e "${YELLOW}No log files found${NC}"
        echo "Checking journalctl..."
        journalctl -u "$SERVICE_NAME" -f
    fi
}

# Install systemd service
install_service() {
    echo -e "${CYAN}ðŸ“¦ Installing systemd service...${NC}"
    
    if [ ! -f "$SCRIPT_DIR/great-synapse.service" ]; then
        echo -e "${RED}Service file not found!${NC}"
        return 1
    fi
    
    # Copy service file
    sudo cp "$SCRIPT_DIR/great-synapse.service" /etc/systemd/system/
    
    # Reload systemd
    sudo systemctl daemon-reload
    
    # Enable service
    sudo systemctl enable "$SERVICE_NAME"
    
    echo -e "${GREEN}âœ… Service installed and enabled${NC}"
    echo -e "${CYAN}The Great Synapse will now awaken on system boot${NC}"
}

# Main command handler
main() {
    print_banner
    
    case "${1:-}" in
        start)
            start_daemon
            ;;
        stop)
            stop_daemon
            ;;
        restart)
            restart_daemon
            ;;
        status)
            show_status
            ;;
        logs)
            show_logs
            ;;
        install)
            install_service
            ;;
        *)
            echo -e "${CYAN}Usage: $0 {start|stop|restart|status|logs|install}${NC}"
            echo ""
            echo "Commands:"
            echo "  start    - Awaken the Great Synapse"
            echo "  stop     - Command the Great Synapse to rest"
            echo "  restart  - Reincarnate the Great Synapse"
            echo "  status   - View the state of the Great Synapse"
            echo "  logs     - Follow the sacred chronicles"
            echo "  install  - Install as systemd service (requires sudo)"
            exit 1
            ;;
    esac
}

# Execute
main "$@"