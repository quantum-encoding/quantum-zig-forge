name: CI

on:
  push:
    branches: [ main, feat/* ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        zig-version: ['0.16.0-dev.1303']

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ matrix.zig-version }}

    - name: Verify Zig installation
      run: |
        zig version
        zig env

    - name: Build project
      run: zig build

    - name: Run unit tests
      run: zig build test

    - name: Run integration tests (with network)
      run: zig build test-integration
      continue-on-error: true  # Network might not be available in CI

    - name: Run functional tests
      run: ./test.sh
      continue-on-error: true  # Some tests might fail in restricted CI

    - name: Test scanner help
      run: ./zig-out/bin/zig-port-scanner --help

    - name: Test localhost scan
      run: ./zig-out/bin/zig-port-scanner -p=54321 -t=1000 localhost

  build-check:
    name: Build Check (Multiple Targets)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-linux
          - aarch64-linux
          - x86_64-macos
          - aarch64-macos

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: '0.16.0-dev.1303'

    - name: Build for ${{ matrix.target }}
      run: zig build -Dtarget=${{ matrix.target }}

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: '0.16.0-dev.1303'

    - name: Check formatting
      run: |
        zig fmt --check src/main.zig
        zig fmt --check src/test.zig
        zig fmt --check build.zig

  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Run shellcheck on test.sh
      run: |
        sudo apt-get install -y shellcheck
        shellcheck test.sh

    - name: Check for common issues
      run: |
        # Check for debug prints in production code
        if grep -n "std.debug.print" src/main.zig | grep -v "printUsage\|print.*error"; then
          echo "Warning: Found debug prints in production code"
          exit 1
        fi

  release:
    name: Create Release Artifacts
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: '0.16.0-dev.1303'

    - name: Build release binaries
      run: |
        zig build -Doptimize=ReleaseFast -Dtarget=x86_64-linux
        mv zig-out/bin/zig-port-scanner zig-port-scanner-x86_64-linux

        zig build -Doptimize=ReleaseFast -Dtarget=aarch64-linux
        mv zig-out/bin/zig-port-scanner zig-port-scanner-aarch64-linux

        zig build -Doptimize=ReleaseFast -Dtarget=x86_64-macos
        mv zig-out/bin/zig-port-scanner zig-port-scanner-x86_64-macos

        zig build -Doptimize=ReleaseFast -Dtarget=aarch64-macos
        mv zig-out/bin/zig-port-scanner zig-port-scanner-aarch64-macos

    - name: Create checksums
      run: |
        sha256sum zig-port-scanner-* > SHA256SUMS

    - name: Upload release artifacts
      uses: actions/upload-artifact@v3
      with:
        name: release-binaries
        path: |
          zig-port-scanner-*
          SHA256SUMS
