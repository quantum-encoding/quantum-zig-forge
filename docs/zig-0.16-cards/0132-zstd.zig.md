# Zig 0.16 Migration Card: std/compress/zstd.zig

## 1) Concept

This file is part of Zig's standard library Zstandard (zstd) compression implementation. It serves as the main entry point for zstd decompression functionality, providing constants, data structures, and test utilities for the zstd format. The file primarily exposes decompression capabilities through the `Decompress` type imported from `zstd/Decompress.zig`, along with default distributions for literals length, match lengths, and offset codes that are used in zstd compression tables.

Key components include default distribution tables for compression statistics, maximum table sizes and accuracy logs, and test utilities that demonstrate the decompression API usage patterns. The file focuses on the low-level building blocks of zstd compression rather than providing high-level compression/decompression functions.

## 2) The 0.11 vs 0.16 Diff

Based on the code analysis, this file shows several Zig 0.16 patterns:

**Explicit Allocator Requirements:**
- The test function `testDecompress` requires an explicit `std.mem.Allocator` parameter
- Uses `std.Io.Writer.Allocating` which internally manages allocation
- Memory management follows the "owner must free" pattern with `defer out.deinit()`

**I/O Interface Changes:**
- Uses the new `std.Io` module with `Reader` and `Writer` interfaces
- `std.Io.Reader.fixed()` creates a reader from a fixed buffer
- Dependency injection pattern with reader/writer interfaces rather than concrete types

**API Structure Changes:**
- `Decompress.init()` takes a reader, dictionary slice, and options struct
- Stream-based processing with `reader.streamRemaining()` method
- No traditional `open`/`close` methods - uses initialization and streaming patterns

**Error Handling:**
- Uses specific error types like `error.BadMagic`, `error.MalformedLiteralsSection`
- Error union return types (`!void`, `![]u8`)
- Error propagation with `try` keyword

## 3) The Golden Snippet

```zig
const std = @import("std");
const zstd = @import("std/compress/zstd.zig");

pub fn decompressZstdData(gpa: std.mem.Allocator, compressed_data: []const u8) ![]u8 {
    var out: std.Io.Writer.Allocating = .init(gpa);
    defer out.deinit();

    var in: std.Io.Reader = .fixed(compressed_data);
    var zstd_stream: zstd.Decompress = .init(&in, &.{}, .{});
    _ = try zstd_stream.reader.streamRemaining(&out.writer);

    return out.toOwnedSlice();
}
```

## 4) Dependencies

- `std.mem` - For allocator functionality and memory management
- `std.debug` - For assertions and debugging utilities  
- `std.Io` - For reader/writer interfaces and streaming I/O
- `std.testing` - For test framework and test allocator

The file heavily relies on the new `std.Io` module for its streaming interface and uses explicit allocator patterns throughout the test utilities, indicating the migration towards more explicit resource management in Zig 0.16.