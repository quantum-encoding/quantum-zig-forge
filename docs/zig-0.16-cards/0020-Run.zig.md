# Migration Card: `std.Build.Step.Run`

## 1) Concept

This file implements the `Run` step type for Zig's build system, which executes external commands as part of the build process. It provides a comprehensive API for configuring command execution, including argument handling, environment variables, working directory, standard I/O behavior, and output file management. Key components include argument types (files, artifacts, output files), stdio configuration (inherited, checked, or Zig test mode), and sophisticated process execution with foreign binary support via emulators like QEMU and Wine.

The step supports both side-effectful commands (always executed) and cacheable commands (only executed when inputs change), with automatic dependency tracking and cross-platform execution capabilities.

## 2) The 0.11 vs 0.16 Diff

### Explicit Allocator Requirements
- **Factory pattern**: Uses `Run.create(owner: *std.Build, name: []const u8)` factory function that obtains allocator from build context
- **No standalone allocator parameter**: All memory allocation is managed through the build system's allocator
- **LazyPath system**: Uses `std.Build.LazyPath` for file/directory arguments instead of raw paths

### I/O Interface Changes
- **StdIo configuration**: New union type with `.infer_from_args`, `.inherit`, `.check`, and `.zig_test` variants
- **Streaming I/O**: Uses `std.Io` abstractions for process communication and polling
- **StdIn configuration**: Separate `stdin` field supporting `.none`, `.bytes`, and `.lazy_path`

### Error Handling Changes
- **Specific error checks**: `StdIo.Check` union for exact/matching stdout/stderr expectations and exit code validation
- **Foreign execution**: Sophisticated error handling for cross-platform execution with emulators
- **Test protocol**: IPC-based communication for Zig unit tests with structured error reporting

### API Structure Changes
- **Argument building**: Multiple `add*Arg` methods replacing monolithic argument construction:
  - `addArtifactArg`, `addFileArg`, `addOutputFileArg`, `addDirectoryArg`
  - `addPrefixed*` variants for argument prefixes
- **Environment management**: `setEnvironmentVariable`, `removeEnvironmentVariable`, `clearEnvironment`
- **Output capture**: `captureStdOut`, `captureStdErr` with configurable options

## 3) The Golden Snippet

```zig
const std = @import("std");

pub fn build(b: *std.Build) void {
    const exe = b.addExecutable(.{
        .name = "myapp",
        .root_source_file = .{ .path = "src/main.zig" },
    });

    const run_step = b.addRunArtifact(exe);
    run_step.addArgs(&.{ "--verbose", "--output", "result.txt" });
    
    // Add input file argument
    run_step.addFileArg(.{ .path = "input.data" });
    
    // Add output file argument and capture the path
    const output_path = run_step.addOutputFileArg("result.txt");
    
    // Configure environment
    run_step.setEnvironmentVariable("DEBUG", "1");
    
    // Set working directory
    run_step.setCwd(.{ .path = "working_dir" });
    
    // Expect specific stdout and exit code
    run_step.expectStdOutEqual("Operation completed successfully");
    run_step.expectExitCode(0);
    
    // Make the run step available as a build target
    b.step("run", "Run the application").dependOn(&run_step.step);
}
```

## 4) Dependencies

- **`std.mem`**: Memory operations and buffer management
- **`std.fs`**: File system operations and path handling
- **`std.process`**: Process spawning and environment management
- **`std.Build`**: Build system context and step infrastructure
- **`std.Io`**: I/O streaming and polling abstractions
- **`std.debug`**: Assertions and debugging utilities
- **`std.crypto`**: Random number generation for temporary directories

This module represents a sophisticated build system component with extensive cross-platform execution capabilities and modern Zig 0.16 patterns for resource management and error handling.