# Migration Analysis: `std/heap.zig`

## 1) Concept

This file serves as the main entry point for Zig's standard library heap allocation system. It provides a collection of memory allocators with different characteristics and use cases. The file acts as a facade that re-exports various specialized allocator implementations while also providing some core allocation utilities directly.

Key components include:
- Global allocator instances (`c_allocator`, `page_allocator`, `smp_allocator`, `wasm_allocator`)
- Platform-specific page size constants and query functions
- Stack-based fallback allocator pattern
- C library integration for malloc/free operations
- Re-exports of specialized allocators (ArenaAllocator, FixedBufferAllocator, etc.)

## 2) The 0.11 vs 0.16 Diff

### Explicit Allocator Requirements
- **Factory functions replaced with direct struct initialization**: Allocators are now created directly using struct literals with vtable patterns rather than factory functions
- **VTable-based interface**: All allocators now use `Allocator.VTable` with function pointers for `alloc`, `resize`, `remap`, and `free`
- **Context pointer usage**: All allocator functions now take a `context: *anyopaque` parameter

### API Structure Changes
- **Direct allocator construction**: Instead of `GeneralPurposeAllocator.init()`, allocators are now constructed as struct literals
- **Removed init/open patterns**: No more `.init()` or `.open()` methods on allocator instances
- **StackFallbackAllocator pattern**: The `stackFallback` function returns a struct that requires calling `.get()` to obtain the allocator interface

### Error Handling Changes
- **Boolean returns for resize**: `resize` now returns `bool` instead of error unions
- **Optional returns for alloc/remap**: `alloc` and `remap` return `?[*]u8` instead of error unions
- **No error propagation**: Most allocation functions no longer use Zig's error handling system

### Alignment Handling
- **`Alignment` type**: Uses `std.mem.Alignment` instead of raw alignment integers
- **Alignment parameter in all functions**: All allocator interface functions now explicitly take alignment parameters

## 3) The Golden Snippet

```zig
const std = @import("std");

test "stack fallback allocator usage" {
    // Create a stack-based fallback allocator
    var stack_allocator = std.heap.stackFallback(4096, std.testing.allocator);
    const allocator = stack_allocator.get();
    
    // Allocate memory
    const slice = try allocator.alloc(u8, 100);
    defer allocator.free(slice);
    
    // Use the allocated memory
    @memset(slice, 0xAA);
    try std.testing.expect(slice[0] == 0xAA);
}
```

## 4) Dependencies

Heavily imported modules that form the dependency graph:

- `std.mem` - Core memory operations and Allocator type
- `std.debug` - Assertions and runtime safety
- `std.testing` - Test utilities
- `std.c` - C standard library integration
- `std.os.windows` - Windows-specific system calls
- `builtin` - Compiler-provided target information

Sub-module dependencies:
- `heap/arena_allocator.zig`
- `heap/FixedBufferAllocator.zig`
- `heap/PageAllocator.zig`
- `heap/ThreadSafeAllocator.zig`
- `heap/WasmAllocator.zig`
- `heap/debug_allocator.zig`
- `heap/memory_pool.zig`

This file represents a significant migration from Zig 0.11's allocator patterns to the more explicit, vtable-based system in 0.16, with clearer separation of concerns and more consistent API patterns across different allocator types.