# HTTP Module Migration Card

## 1) Concept

This file is the main HTTP module for Zig's standard library, providing core HTTP protocol types and functionality. It defines HTTP versions, methods, status codes, and implements HTTP message parsing and writing. The module serves as an umbrella that exports submodules for HTTP client, server, and specialized parsers.

Key components include:
- HTTP protocol definitions (Version, Method, Status enums)
- HTTP message reader for parsing requests/responses with support for chunked encoding and compression
- HTTP body writer for constructing responses with different transfer encodings
- Header parsing and iteration utilities
- Submodules for Client and Server implementations

## 2) The 0.11 vs 0.16 Diff

### Explicit Allocator Requirements
- No explicit allocator patterns in this file - the API is designed around streaming I/O without dynamic allocation
- Reader and Writer interfaces work with pre-allocated buffers provided by the caller

### I/O Interface Changes
- Uses new `std.Io.Reader` and `std.Io.Writer` interfaces throughout
- Dependency injection via `*std.Io.Reader` and `*Writer` parameters
- `BodyWriter` wraps an underlying `http_protocol_output: *Writer`

### Error Handling Changes
- Specific error sets: `HeadError` and `BodyError` for different failure modes
- `HeadError` includes `HttpHeadersOversize`, `HttpRequestTruncated`, `HttpConnectionClosing`, `ReadFailed`
- `BodyError` includes `HttpChunkInvalid`, `HttpChunkTruncated`, `HttpHeadersOversize`

### API Structure Changes
- Factory pattern for body readers: `bodyReader()` and `bodyReaderDecompressing()` methods
- State machine management in `Reader.State` for tracking parsing progress
- Explicit transfer encoding and content length parameters in reader initialization

## 3) The Golden Snippet

```zig
const std = @import("std");

// Example of using HTTP Reader to parse a request head
fn exampleHttpParsing(allocator: std.mem.Allocator, socket_reader: *std.Io.Reader) !void {
    var http_reader = std.http.Reader{
        .in = socket_reader,
        .interface = undefined, // will be initialized by bodyReader
        .state = .ready,
        .max_head_len = 8192,
    };
    
    // Read HTTP head
    const head_bytes = try http_reader.receiveHead();
    
    // Parse headers and determine transfer encoding
    const transfer_encoding = .chunked;
    const content_length: ?u64 = null;
    
    // Get body reader
    var transfer_buffer: [4096]u8 = undefined;
    const body_reader = http_reader.bodyReader(
        &transfer_buffer,
        transfer_encoding,
        content_length
    );
    
    // Now read from body_reader...
}
```

## 4) Dependencies

- `std.Io` (Reader/Writer interfaces)
- `std.compress.flate` (deflate/gzip decompression)
- `std.compress.zstd` (zstd decompression)
- `std.fs.File` (file operations for sendfile)
- `std.debug` (assertions)
- `std.mem` (memory operations in writeHex)
- `std.math` (mathematical operations)