# Migration Card: `std.fs.Dir`

## 1) Concept

This file defines the `Dir` type, which represents an open directory handle in Zig's standard library. It provides comprehensive directory operations including iteration, file/directory creation/deletion, path resolution, and recursive directory traversal. The key components include:

- **Directory iteration**: Platform-specific iterator implementations (Linux, Windows, macOS, BSD variants, WASI) for reading directory entries
- **File operations**: Opening, creating, reading, writing, and deleting files within directories
- **Directory management**: Creating, removing, and traversing directory structures
- **Path resolution**: Realpath functionality for canonical path resolution
- **Symbolic link operations**: Creating and reading symbolic links
- **Recursive operations**: Walker implementations for recursive directory traversal

**CRITICAL NOTE**: The file is marked as deprecated in favor of `std.Io.Dir` with the comment "Deprecated in favor of `Io.Dir`" at the top. This indicates a major API migration path.

## 2) The 0.11 vs 0.16 Diff

### Explicit Allocator Requirements
- **Recursive operations now require explicit allocators**: `walk()`, `walkSelectively()`, `readFileAlloc()`, and `realpathAlloc()` all take explicit `Allocator` parameters
- **Memory management in walkers**: `SelectiveWalker` and `Walker` types manage their own internal buffers using the provided allocator
- **File reading with allocation**: `readFileAlloc()` and `readFileAllocOptions()` require allocators for buffer management

### I/O Interface Changes
- **New I/O system integration**: Most file operations now delegate to `Io.Dir` through adapter patterns
- **Threaded I/O context**: Functions like `openFile()`, `createFile()`, `makeDir()` use `Io.Threaded.init_single_threaded()` and `ioBasic()` for I/O operations
- **Adapter pattern**: `adaptToNewApi()` and `adaptFromNewApi()` methods convert between old and new directory representations

### API Structure Changes
- **Factory function pattern**: Many operations now use the new `Io.Dir` API through adapter methods
- **Error type unification**: Error types are now aliased from `Io.Dir` (e.g., `MakeError = Io.Dir.MakeError`)
- **Deprecation pathway**: All major functions are marked as deprecated with comments pointing to `Io.Dir` equivalents

### Function Signature Changes
```zig
// Old pattern (deprecated)
pub fn openFile(self: Dir, sub_path: []const u8, flags: File.OpenFlags) File.OpenError!File

// New pattern uses Io.Dir internally
pub fn openFile(self: Dir, sub_path: []const u8, flags: File.OpenFlags) File.OpenError!File {
    var threaded: Io.Threaded = .init_single_threaded;
    const io = threaded.ioBasic();
    return .adaptFromNewApi(try Io.Dir.openFile(self.adaptToNewApi(), io, sub_path, flags));
}
```

## 3) The Golden Snippet

```zig
const std = @import("std");

pub fn main() !void {
    const allocator = std.heap.page_allocator;
    
    // Open current working directory
    var cwd = std.fs.cwd();
    
    // Iterate through directory entries
    var iter = cwd.iterate();
    while (try iter.next()) |entry| {
        std.debug.print("Name: {s}, Kind: {}\n", .{entry.name, entry.kind});
    }
    
    // Recursive directory walk
    var walker = try cwd.walk(allocator);
    defer walker.deinit();
    
    while (try walker.next()) |walk_entry| {
        std.debug.print("Path: {s}, Depth: {}\n", .{walk_entry.path, walk_entry.depth()});
        
        if (walk_entry.kind == .directory) {
            // Optionally skip descending into this directory
            // walker.leave();
        }
    }
    
    // Create a new file
    var file = try cwd.createFile("example.txt", .{});
    defer file.close();
    try file.writeAll("Hello, Zig 0.16!");
}
```

## 4) Dependencies

The file heavily imports these modules, indicating its dependency graph:

- **`std.mem`**: Memory operations and buffer management
- **`std.posix`**: Platform-specific system calls
- **`std.Io`**: New I/O system (migration target)
- **`std.fs.File`**: File operations
- **`std.fs.path`**: Path manipulation utilities
- **`std.os.windows`**: Windows-specific APIs
- **`std.os.linux`**: Linux-specific APIs
- **Platform-specific modules**: Various OS-specific implementations

**Migration Strategy**: This module is in transition to the new `Io.Dir` system. New code should use `std.Io.Dir` directly, while existing code will need migration to the new I/O interfaces with explicit allocator requirements and the new threaded I/O context pattern.