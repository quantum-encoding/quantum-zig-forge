# Migration Card: std.Uri

## 1) Concept
This file implements Uniform Resource Identifier (URI) parsing and manipulation functionality roughly adhering to RFC 3986. It provides a robust URI parser that handles common URI formats found in the wild, with components for scheme, user authentication, host, port, path, query, and fragment.

Key components include:
- The `Uri` struct containing parsed URI components
- `Component` union for handling raw vs percent-encoded URI segments
- Parsing functions (`parse`, `parseAfterScheme`) that extract URI components from strings
- Formatting utilities with configurable output flags
- URI resolution functionality (`resolveInPlace`) for handling relative URIs against base URIs
- Percent encoding/decoding utilities for proper URI component handling

## 2) The 0.11 vs 0.16 Diff

### Explicit Allocator Requirements
- **`getHostAlloc`**: New function requiring explicit arena allocator for hostname resolution
  ```zig
  // 0.16 pattern
  pub fn getHostAlloc(uri: Uri, arena: Allocator) GetHostAllocError!HostName
  ```

- **Component.toRawMaybeAlloc**: Component method that optionally allocates
  ```zig
  pub fn toRawMaybeAlloc(component: Component, arena: Allocator) Allocator.Error![]const u8
  ```

### I/O Interface Changes
- **Writer-based formatting**: All formatting functions use dependency-injected `Writer` interface
  ```zig
  pub fn format(uri: *const Uri, writer: *Writer) Writer.Error!void
  pub fn writeToStream(uri: *const Uri, writer: *Writer, flags: Format.Flags) Writer.Error!void
  ```

- **Component formatting methods**: Each component type has specific writer-based formatting
  ```zig
  formatUser, formatPassword, formatHost, formatPath, formatQuery, formatFragment
  ```

### Error Handling Changes
- **Specific error sets**: Functions return specific error types rather than generic errors
  ```zig
  pub const GetHostError = error{UriMissingHost};
  pub const GetHostAllocError = GetHostError || error{OutOfMemory};
  pub const ParseError = error{UnexpectedCharacter, InvalidFormat, InvalidPort, InvalidHostName};
  pub const ResolveInPlaceError = ParseError || error{NoSpaceLeft};
  ```

### API Structure Changes
- **Buffer-based operations**: Functions like `getHost` and `percentDecodeBackwards` use caller-provided buffers
- **Format configuration**: Structured `Format.Flags` for controlling URI component output
- **Alternative formatting**: Use of `std.fmt.alt` for component-specific formatting modes

## 3) The Golden Snippet

```zig
const std = @import("std");
const Uri = std.Uri;

pub fn main() !void {
    var arena = std.heap.ArenaAllocator.init(std.heap.page_allocator);
    defer arena.deinit();
    
    const uri = try Uri.parse("https://user:pass@example.com:8080/path?query=value#fragment");
    
    // Get host with arena allocation
    const host = try uri.getHostAlloc(arena.allocator());
    std.debug.print("Host: {s}\n", .{host.bytes});
    
    // Format URI with specific components
    var buffer: [1024]u8 = undefined;
    var fbs = std.io.fixedBufferStream(&buffer);
    const writer = fbs.writer();
    
    try uri.writeToStream(&writer, .{
        .scheme = true,
        .authority = true,
        .path = true,
        .query = true,
        .fragment = true
    });
    
    std.debug.print("Full URI: {s}\n", .{fbs.getWritten()});
}
```

## 4) Dependencies

- **std.mem** - Memory allocation and buffer operations
- **std.fmt** - String formatting and printing
- **std.io** - I/O writer interfaces and stream operations  
- **std.io.net** - Hostname validation and network types
- **std.heap** - (Indirectly) for allocator-based operations

The module has moderate dependencies focused on string processing, formatting, and basic I/O operations, with no heavy external system dependencies.