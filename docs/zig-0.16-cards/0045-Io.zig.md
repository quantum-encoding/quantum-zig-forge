# Migration Card: `std.Io.zig`

## 1) Concept

This file provides the core I/O abstraction layer for Zig's standard library, implementing a portable interface for asynchronous and synchronous I/O operations. It serves as a unified facade over different I/O backends (evented, threaded, etc.) while providing cancellation-aware operations.

Key components include:
- **Limit enum**: For managing I/O size limits with utilities for bounded operations
- **Poller system**: Cross-platform file descriptor polling (POSIX poll/Windows overlapped I/O)
- **Io interface**: Abstract I/O operations via vtable for dependency injection
- **Async primitives**: Futures, Groups, Select for structured concurrency
- **Synchronization**: Mutex, Condition variables, and thread-safe Queues
- **Clock abstraction**: Multiple clock types (real, monotonic, CPU-time) with timestamp/duration utilities

## 2) The 0.11 vs 0.16 Diff

### Explicit Allocator Requirements
- **Polling allocator injection**: `poll()` function now requires `gpa: Allocator` as first parameter
- **Memory management in Poller**: `Poller.deinit()` and internal buffer management require explicit allocator
- **Reader buffer allocation**: `writableSliceGreedyAlloc()` takes allocator parameter for dynamic buffer growth

### I/O Interface Changes
- **VTable-based abstraction**: Complete dependency injection pattern via `Io.vtable` with function pointers
- **Platform-specific backends**: `Evented` and `Threaded` I/O implementations selected at compile-time
- **Cancellation-aware operations**: All blocking operations support `Cancelable!` error set

### Error Handling Changes
- **Structured cancellation**: `Cancelable = error{Canceled}` used throughout async operations
- **OS error wrapping**: `UnexpectedError` for undocumented system error codes
- **Clock-specific errors**: `Clock.Error` and `SleepError` with clock support detection

### API Structure Changes
- **Future-based async**: `async()`/`concurrent()` return `Future(T)` instead of direct async frames
- **Group coordination**: `Group` type for managing multiple async tasks
- **Select operations**: `select()` for waiting on multiple futures with union results
- **Timeout abstractions**: `Timeout` union (none/duration/deadline) replaces ad-hoc timeout parameters

## 3) The Golden Snippet

```zig
const std = @import("std");
const Io = std.Io;

// Example: Using the Poller for multiple stream monitoring
pub fn monitorStreams(gpa: std.mem.Allocator, stdin: std.fs.File, stdout: std.fs.File) !void {
    const Streams = enum { stdin, stdout };
    
    const files = Io.PollFiles(Streams){
        .stdin = stdin,
        .stdout = stdout,
    };
    
    var poller = Io.poll(gpa, Streams, files);
    defer poller.deinit();
    
    while (try poller.poll()) {
        if (poller.reader(.stdin).buffered().len > 0) {
            const data = try poller.toOwnedSlice(.stdin);
            defer gpa.free(data);
            // Process stdin data
        }
        
        if (poller.reader(.stdout).buffered().len > 0) {
            const data = try poller.toOwnedSlice(.stdout);
            defer gpa.free(data);
            // Process stdout data
        }
    }
}
```

## 4) Dependencies

**Heavily imported modules:**
- `std.mem` (Allocator, memory operations)
- `std.posix` (POSIX system calls)
- `std.os.windows` (Windows API)
- `std.math` (mathematical operations)
- `std.debug` (assertions)
- `std.time` (timestamp conversions)

**Internal dependencies:**
- `Io/Reader.zig`
- `Io/Writer.zig`
- `Io/tty.zig`
- `Io/net.zig`
- `Io/Dir.zig`
- `Io/File.zig`
- Platform-specific backends (`IoUring.zig`, `Kqueue.zig`, `Threaded.zig`)

**Cross-platform abstractions:**
- POSIX poll vs Windows overlapped I/O
- Multiple clock implementations
- Async/sync operation unification