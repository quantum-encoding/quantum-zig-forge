# Migration Card: std/fs/wasi.zig

## 1) Concept

This file provides WASI (WebAssembly System Interface) specific filesystem functionality for handling preopened directories. Preopens are directories that are made available to WebAssembly programs by the host environment before execution starts. The main component is the `Preopens` struct which tracks preopened directory names indexed by file descriptor numbers, and provides a method to look up file descriptors by directory name.

Key components include:
- `Preopens` struct with a `names` slice mapping file descriptors to directory paths
- `find()` method to locate file descriptors by directory name
- `preopensAlloc()` function that discovers all preopened directories using WASI system calls

## 2) The 0.11 vs 0.16 Diff

**Explicit Allocator Requirements:**
- `preopensAlloc(gpa: Allocator)` now requires explicit allocator parameter
- Uses `std.ArrayListUnmanaged` for memory management with explicit allocator
- Returns `Allocator.Error` explicitly in error set

**I/O Interface Changes:**
- Direct WASI system call interface (`wasi.fd_prestat_get`, `wasi.fd_prestat_dir_name`)
- No traditional file I/O abstraction - works directly with WASI file descriptors
- Error handling uses WASI-specific error codes via switch statements

**Error Handling Changes:**
- Function returns specific `Allocator.Error` rather than generic error set
- WASI system call errors handled via exhaustive switch with panic on unexpected errors
- Only `.OPNOTSUPP` and `.BADF` treated as expected terminal conditions

**API Structure Changes:**
- Factory function pattern (`preopensAlloc`) rather than struct initialization
- Explicit resource management with `defer` and `errdefer`
- Preopens discovery via iterative system calls starting from known descriptors

## 3) The Golden Snippet

```zig
const std = @import("std");
const fs = std.fs;

pub fn main() !void {
    var gpa = std.heap.GeneralPurposeAllocator(.{}){};
    const allocator = gpa.allocator();
    
    const preopens = try fs.wasi.preopensAlloc(allocator);
    defer allocator.free(preopens.names);
    
    if (preopens.find("/some/directory")) |fd| {
        std.debug.print("Found directory at fd: {d}\n", .{fd});
    }
}
```

## 4) Dependencies

- `std.mem` - Memory operations and allocator interface
- `std.os.wasi` - WASI system call definitions and types
- `std.ArrayListUnmanaged` - Dynamic array with manual memory management
- `std.debug` - Assertion functionality
- `std.math` - Mathematical utilities (imported but not heavily used)